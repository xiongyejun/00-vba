[http://club.excelhome.net/forum.php?mod=viewthread&tid=980303&extra=page%3D1](http://club.excelhome.net/forum.php?mod=viewthread&tid=980303&extra=page%3D1)

# 验证码识别 第3辑： #

	Public Const STATUS_OK = 0
	Public Const NOERROR = 0
	Public Type GUID
	    Data1 As Long
	    Data2 As Integer
	    Data3 As Integer
	    Data4(0 To 7) As Byte
	End Type
	
	Public Type GdiplusStartupInput
	    GdiplusVersion As Long
	    DebugEventCallback As Long
	    SuppressBackgroundThread As Long
	    SuppressExternalCodecs As Long
	End Type
	
	Public Declare Function GdiplusStartup Lib "GDIPlus" (token As Long, inputbuf As GdiplusStartupInput, ByVal outputbuf As Long) As Long
	Public Declare Function GdiplusShutdown Lib "GDIPlus" (ByVal token As Long) As Long
	Public Declare Function GdipSaveImageToFile Lib "GDIPlus" (ByVal Image As Long, ByVal FileName As Long, clsidEncoder As GUID, encoderParams As Any) As Long
	Public Declare Function GdipCreateBitmapFromFile Lib "GDIPlus" (ByVal FileName As Long, BITMAP As Long) As Long
	Public Declare Function GdipDisposeImage Lib "GDIPlus" (ByVal Image As Long) As Long
	Public Declare Function CLSIDFromString Lib "ole32" (ByVal Str As Long, id As GUID) As Long
	
	Public Function PNGtoBMP(ByVal SourceFilename As String, ByVal DestinationFilename As String) As Boolean
	    Dim GSI As GdiplusStartupInput
	    Dim lGDIP As Long
	    Dim lBitmap As Long
	    Dim bmpEncoder As GUID
	    GSI.GdiplusVersion = 1
	    If GdiplusStartup(lGDIP, GSI, 0) = STATUS_OK Then
	        If GdipCreateBitmapFromFile(StrPtr(SourceFilename), lBitmap) = STATUS_OK Then
	            If CLSIDFromString(StrPtr("{557CF400-1A04-11D3-9A73-0000F81EF32E}"), bmpEncoder) = NOERROR Then
	                If GdipSaveImageToFile(lBitmap, StrPtr(DestinationFilename), bmpEncoder, ByVal 0) = STATUS_OK Then
	                    PNGtoBMP = True
	                End If
	            End If
	            Call GdipDisposeImage(lBitmap)
	        End If
	        Call GdiplusShutdown(lGDIP)
	    End If
	End Function


	Private Sub CommandButton1_Click()    '广东地税验证码，png格式，转为Bmp格式，然后识别。
	    Dim crr() As Byte
	    Dim arr()
	    Dim brr()
	    Dim ret As Boolean
	    On Error Resume Next
	    Sheet10.Activate
	    Set oDoc = CreateObject("htmlfile")
	    With CreateObject("Msxml2.XMLHTTP.6.0")
	1:
	        .Open "POST", "http://www.gdltax.gov.cn/fpzx/jsp/fpzx/mhcx/yzm.do", False
	        .SetRequestHeader "Referer", "http://www.gdltax.gov.cn/fpzx/jsp/fpzx/mhcx/mh_cjdj_dzfpsjcx_index.do?siteName=gd&styleName=blue"
	        .SetRequestHeader "Connection", "Keep-Alive"
	        .send
	        urls = "http://www.gdltax.gov.cn" & Split(Split(.responsetext, "src=""")(1), """")(0)
	        .Open "GET", urls, False
	        .send
	        If "c:\2.bmp" <> "" Then Kill "c:\2.bmp"
	        If "C:\2.png" <> "" Then Kill "C:\2.png"
	        crr = .responseBody
	        Open "c:\2.png" For Binary As #1
	        For i = 0 To UBound(.responseBody)
	            Put #1, i + 1, crr(i)
	        Next i
	        Close #1
	        ret = PNGtoBMP("C:\2.png", "C:\2.bmp")
	        Erase crr()
	        .Open "GET", "c:\2.bmp", False
	        .send
	        crr = .responseBody
	        kuandu = Val(crr(18))
	        gaodu = Val(crr(22))
	        ReDim arr(1 To kuandu * gaodu)
	        ReDim brr(1 To gaodu, 1 To kuandu)
	        a1 = 54
	        For i = 1 To kuandu * gaodu
	            arr(i) = ""
	            ts = 0
	            For j = 0 To 2
	                ts = ts + Val(crr((i - 1) * 3 + a1 + j))
	            Next j
	            ts = ts / 3
	            If ts < 180 Then
	                arr(i) = 1
	            End If
	            If i / kuandu = Int(i / kuandu) Then a1 = a1 + 0
	
	        Next i
	        For i = 1 To gaodu
	            For j = 1 To kuandu
	                brr(gaodu + 1 - i, j) = arr((i - 1) * kuandu + j)
	            Next j
	        Next i
	
	        Dim b(0 To 11)
	        Dim a(0 To 11)
	        a(0) = "1": b(0) = "44cc22"
	        a(1) = "2": b(1) = "58766676"
	        a(2) = "5": b(2) = "9a666896"
	        a(3) = "6": b(3) = "58877764"
	        a(4) = "8": b(4) = "8a7667a6"
	        a(5) = "9": b(5) = "48867995"
	        a(6) = "A": b(6) = "2433554994"
	        a(7) = "C": b(7) = "58644555"
	        a(8) = "D": b(8) = "bc44445564"
	        a(9) = "F": b(9) = "cc4444441"
	        a(10) = "V": b(10) = "377526862"
	        a(11) = "X": b(11) = "4644446564"
	        p = ""
	        For i = 1 To kuandu
	            sst = 0
	            For j = 5 To 16
	                sst = sst + brr(j, i)
	            Next j
	            If sst = 10 Then sst = "a"
	            If sst = 11 Then sst = "b"
	            If sst = 12 Then sst = "c"
	            If sst = 13 Then sst = "d"
	            p = p & sst
	            p = Replace(p, "0", " ")
	        Next i
	        For i = 0 To 11
	            p = Replace(p, b(i), a(i))
	        Next i
	        p = Replace(p, " ", "")
	        yzm = Format(p, "0000")
	        If Len(yzm) <> 4 Then GoTo 1
	        n = Range("a65536").End(xlUp).Row + 1
	        Cells(n, 1) = yzm
	        ML = Cells(n, "b").Left
	        MT = Cells(n, "b").Top
	        MW = Cells(n, "b").Width
	        MH = Cells(n, "b").Height
	        ActiveSheet.Shapes.AddShape(msoShapeRectangle, ML, MT, MW, MH).Select
	        Selection.ShapeRange.Fill.UserPicture "C:\2.png"
	        Selection.ShapeRange.Line.Visible = False
	        Erase arr()
	        Erase brr()
	        Erase crr()
	        Erase b()
	        Erase a()
	    End With
	End Sub
